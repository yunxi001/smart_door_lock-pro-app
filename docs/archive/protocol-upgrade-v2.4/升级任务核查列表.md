# 协议升级任务核查列表 v2.3 → v2.4

**执行日期**: 2026-01-31  
**执行人**: Kiro AI

---

## ✅ 任务清单

### 📦 第一阶段：核心功能修改（必须）

#### ✅ 任务 1: 修改 server_ack 错误码处理

- [ ] 1.1 修改 `services/DeviceService.ts` 中的 `handleServerAck()` 方法
  - [ ] 删除 case 1（设备离线）
  - [ ] 删除 case 2（参数错误）→ 统一为 case 3
  - [ ] 删除 case 4（内部错误）
  - [ ] 修改 case 5（重复消息）→ 改为 case 9
  - [ ] 保留 case 0（成功）
  - [ ] 保留 case 3（参数错误）
  - [ ] 新增 case 8（未认证）
  - [ ] 新增 case 9（重复消息）
  - [ ] 添加 default 分支处理未知错误码
- [ ] 1.2 更新相关日志消息
- [ ] 1.3 验证逻辑正确性

#### ✅ 任务 3: 更新错误消息映射

- [ ] 3.1 修改 `getAckErrorMessage()` 方法
  - [ ] 确保 0-10 错误码都有准确描述
  - [ ] 添加用户友好的操作建议
- [ ] 3.2 验证错误消息准确性

#### ✅ 任务 5: 更新测试用例

- [ ] 5.1 更新 `test/DeviceService.test.ts`
  - [ ] 修改 "server_ack code=1" → "server_ack code=3"
  - [ ] 修改 "server_ack code=2" → 删除或改为 code=3
  - [ ] 修改 "server_ack code=5" → "server_ack code=9"
  - [ ] 新增 "server_ack code=8" 测试
  - [ ] 删除 code=4 相关测试
- [ ] 5.2 更新 `test/timeoutRetry.test.ts`
  - [ ] 修改 "server_ack (code=1)" → "server_ack (code=3)"
  - [ ] 修改 "server_ack (code=5)" → "server_ack (code=9)"
- [ ] 5.3 更新 `test/protocol-alignment-properties.test.ts`
  - [ ] 修改 code=1 测试 → code=3
  - [ ] 修改 code=5 测试 → code=9
- [ ] 5.4 更新 `test/loggingEnhancement.test.ts`
  - [ ] 更新所有 server_ack 相关测试的 code 值
- [ ] 5.5 运行所有测试，确保通过

---

### 🚀 第二阶段：新功能添加（推荐）

#### ✅ 任务 2: 新增密码查询接口

- [ ] 2.1 在 `services/DeviceService.ts` 中添加 `queryPassword()` 方法
- [ ] 2.2 修改 `handleQueryResult()` 方法
  - [ ] 添加 `target === "password"` 分支
  - [ ] 触发 `password_query_result` 事件
  - [ ] 处理默认值 "123456"
- [ ] 2.3 添加事件类型定义
- [ ] 2.4 新建测试文件 `test/passwordQuery.test.ts`
  - [ ] 测试发送 query 命令
  - [ ] 测试成功响应处理
  - [ ] 测试默认值返回
- [ ] 2.5 运行测试，确保通过

---

### 🔧 第三阶段：类型和文档（可选）

#### ✅ 任务 6: 更新类型定义

- [ ] 6.1 在 `types.ts` 中添加新类型
  - [ ] `PasswordQueryResult` 接口
  - [ ] `MediaDownloadStrategy` 接口（可选）
- [ ] 6.2 更新现有类型（如需要）
- [ ] 6.3 验证类型定义无冲突

#### ✅ 任务 7: 更新文档注释

- [ ] 7.1 更新 `handleServerAck()` 方法注释
  - [ ] 说明协议 v2.4 变更
  - [ ] 列出支持的错误码
  - [ ] 添加注意事项
- [ ] 7.2 更新 `handleAck()` 方法注释
- [ ] 7.3 为 `queryPassword()` 添加完整注释
- [ ] 7.4 更新其他相关方法注释

---

## 🧪 验证检查清单

### 代码质量检查

- [ ] ✅ 无 TypeScript 类型错误
- [ ] ✅ 无 ESLint 警告
- [ ] ✅ 代码格式正确
- [ ] ✅ 注释清晰完整

### 功能验证

- [ ] ✅ server_ack 只处理 code 0/3/8/9
- [ ] ✅ 密码查询功能正常工作
- [ ] ✅ 错误消息准确且用户友好
- [ ] ✅ 所有事件正确触发

### 测试验证

- [ ] ✅ 所有单元测试通过
- [ ] ✅ 测试覆盖率 ≥ 80%
- [ ] ✅ 无测试失败或跳过

### 兼容性检查

- [ ] ✅ 与现有代码无冲突
- [ ] ✅ 事件订阅者无需修改
- [ ] ✅ 向后兼容（如需要）

---

## 📝 执行记录

### 任务 1: 修改 server_ack 错误码处理

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

### 任务 2: 新增密码查询接口

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

### 任务 3: 更新错误消息映射

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

### 任务 5: 更新测试用例

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

### 任务 6: 更新类型定义

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

### 任务 7: 更新文档注释

- **开始时间**: ****\_\_\_****
- **完成时间**: ****\_\_\_****
- **状态**: ⏳ 进行中 / ✅ 完成 / ❌ 失败
- **备注**: ****\_\_\_****

---

## 🎯 最终验收

- [ ] ✅ 所有任务完成
- [ ] ✅ 所有检查项通过
- [ ] ✅ 代码已提交
- [ ] ✅ 文档已更新

**验收人**: ****\_\_\_****  
**验收日期**: ****\_\_\_****  
**验收结果**: ✅ 通过 / ❌ 不通过

---

**创建时间**: 2026-01-31  
**最后更新**: ****\_\_\_****
