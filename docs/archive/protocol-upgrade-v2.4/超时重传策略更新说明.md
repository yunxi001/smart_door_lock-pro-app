# 超时重传策略更新说明

## 更新日期

2024-12-11

## 更新内容

### 1. 命令分类调整

将所有命令分为两大类：

#### 与设备交互的命令（不重传）

- `user_mgmt`: 90秒超时，0次重传
- `lock_control`: 20秒超时，0次重传
- `dev_control`: 20秒超时，0次重传

#### 与服务器交互的命令（需要重传）

- `system`: 3秒超时，3次重传
- `query`: 3秒超时，3次重传
- `face_management`: 3秒超时，3次重传
- `media_download`: 3秒超时，3次重传
- `media_download_chunk`: 3秒超时，3次重传

### 2. 重传机制

- 重传时使用相同的 `seq_id`
- 服务器通过 seq_id 缓存识别重复消息
- 重复消息返回 `server_ack` (code=5)

### 3. 更新的文件

#### 代码文件

- `services/DeviceService.ts`: 实现自动配置逻辑
  - 新增 `getCommandConfig()` 方法
  - 更新 `sendCommand()` 方法
  - 更新 `handleTimeout()` 方法
  - 更新所有命令发送方法的注释

#### 文档文件

- `docs/智能猫眼门锁系统-服务器与App通信协议规范-v2.3.md`: 更新重传策略说明
- `docs/命令分类与超时重传策略.md`: 新增详细说明文档

#### 测试文件

- `test/timeoutRetry.test.ts`: 完全重写测试用例
  - 新增设备命令超时测试（不重传）
  - 新增服务器命令超时和重传测试
  - 新增用户自定义配置测试

### 4. 设计考虑

#### 为什么设备命令不重传？

1. **避免重复执行**:
