# 协议 v2.4 升级实现报告

> **升级日期**: 2026-02-01  
> **协议版本**: v2.4  
> **实现状态**: ✅ 已完成

## 一、升级概述

根据《智能猫眼门锁系统-服务器与App通信协议规范-v2.4(新).md》，本次升级主要实现以下两个新特性：

1. **user_mgmt 命令新增 `user_name` 字段支持**
2. **新增 `doorlock_users` 查询接口**

## 二、实现内容

### 2.1 类型定义更新 (types.ts)

新增以下类型定义：

```typescript
/**
 * 门锁用户信息接口
 * 协议 v2.4 新增 - 第 9.7 节
 */
export interface DoorlockUser {
  id: number; // 数据库记录 ID
  device_id: string; // 设备 MAC 地址
  user_type: "finger" | "nfc" | "password"; // 用户类型
  user_id: number; // ESP32 分配的用户 ID
  user_name: string; // 用户备注名称
  user_data?: string; // 额外数据（如 NFC 卡号）
  status: number; // 状态：0=已删除，1=正常
  created_at: string; // 创建时间
  created_by: string; // 创建者 app_id
}

/**
 * 门锁用户查询结果接口
 * 协议 v2.4 新增
 */
export interface DoorlockUsersQueryResult {
  records: DoorlockUser[];
  total: number;
  limit: number;
  offset: number;
}
```

### 2.2 DeviceService 更新

#### 2.2.1 sendUserMgmtCommand 方法增强

**修改位置**: `services/DeviceService.ts` 第 1305-1365 行

**新增参数**:

```typescript
public sendUserMgmtCommand(
  category: "finger" | "nfc" | "password",
  command: string,
  userId?: number,
  payload?: string,
  userName?: string,  // 新增：用户备注名称
): string | null
```

**实现逻辑**:

- 仅在 `command === "add"` 时将 `user_name` 字段添加到消息中
- Server 会将 `user_name` 存储到数据库，ESP32 不接收此字段
- 日志消息中包含用户备注信息

**示例**:

```typescript
// 添加指纹并设置备注
service.sendUserMgmtCommand("finger", "add", 0, undefined, "张三的右手食指");

// 发送的消息格式：
{
  "type": "user_mgmt",
  "category": "finger",
  "command": "add",
  "user_id": 0,
  "user_name": "张三的右手食指",
  "seq_id": "1738419934567_0"
}
```

#### 2.2.2 新增 queryDoorlockUsers 方法

**位置**: `services/DeviceService.ts` 第 1644-1675 行

**方法签名**:

```typescript
public queryDoorlockUsers(
  userType?: "finger" | "nfc" | "password",
  limit: number = 100,
  offset: number = 0,
): string | null
```

**功能说明**:

- 查询设备的指纹、NFC、密码用户列表
- 支持按用户类型过滤
- 支持分页查询（limit, offset）
- 数据从服务器数据库读取，不查询 ESP32

**示例**:

```typescript
// 查询所有指纹用户
service.queryDoorlockUsers("finger");

// 查询所有类型用户（分页）
service.queryDoorlockUsers(undefined, 50, 0);

// 发送的消息格式：
{
  "type": "query",
  "target": "doorlock_users",
  "data": {
    "user_type": "finger",
    "limit": 100,
    "offset": 0
  },
  "seq_id": "1738419934567_1"
}
```

#### 2.2.3 handleQueryResult 方法更新

**位置**: `services/DeviceService.ts` 第 1839-1850 行

新增对 `doorlock_users` 查询结果的处理：

```typescript
case "doorlock_users":
  // 协议 v2.4 新增：门锁用户列表查询
  this.emit("doorlock_users_result", {
    data: records,
    total: total || 0,
  });
  this.emit("log", {
    msg: `获取门锁用户列表成功，共 ${records.length} 条`,
    type: "success",
  });
  break;
```

#### 2.2.4 getQueryTargetText 方法更新

**位置**: `services/DeviceService.ts` 第 1420-1432 行

新增查询目标的中文描述：

```typescript
private getQueryTargetText(target: string): string {
  const targetMap: Record<string, string> = {
    status: "设备状态",
    status_history: "历史状态",
    events: "事件记录",
    unlock_logs: "开锁日志",
    media_files: "媒体文件列表",
    password: "设备密码",
    doorlock_users: "门锁用户列表",  // 新增
  };
  return targetMap[target] || target;
}
```

## 三、测试验证

### 3.1 测试文件

创建了完整的测试套件：`test/doorlockUsers.test.ts`

### 3.2 测试覆盖

✅ **user_mgmt 命令 user_name 字段测试** (6 个测试用例)

- 添加指纹时支持 user_name 参数
- 添加 NFC 卡片时支持 user_name 参数
- user_name 参数为可选
- 非 add 命令时不包含 user_name 字段
- 删除命令时不包含 user_name 字段
- 日志包含 user_name 信息

✅ **doorlock_users 查询接口测试** (8 个测试用例)

- queryDoorlockUsers 方法存在性
- 发送正确的查询命令
- 支持用户类型过滤
- 支持分页参数
- 正确处理查询结果
- 记录查询日志
- 查询所有类型时日志显示正确
- 返回 seq_id

✅ **集成测试** (1 个测试用例)

- 完整工作流：添加指纹 → 查询用户列表

### 3.3 测试结果

```
✓ test/doorlockUsers.test.ts (15 tests) 8ms
  ✓ 门锁用户管理 (协议 v2.4) (15)
    ✓ user_mgmt 命令新增 user_name 字段 (6)
    ✓ doorlock_users 查询接口 (8)
    ✓ 集成测试：完整工作流 (1)

Test Files  1 passed (1)
     Tests  15 passed (15)
```

## 四、使用示例

### 4.1 添加指纹并设置备注

```typescript
import { deviceService } from "@/services/DeviceService";

// 添加指纹（带备注）
deviceService.sendUserMgmtCommand(
  "finger", // 类别
  "add", // 命令
  0, // user_id (0=自动分配)
  undefined, // payload (指纹不需要)
  "张三的右手食指", // user_name (新增)
);

// 监听添加结果
deviceService.on("finger_result", (type, data) => {
  if (data.result === "success") {
    console.log(`指纹添加成功，ID: ${data.userId}`);
  }
});
```

### 4.2 查询门锁用户列表

```typescript
import { deviceService } from "@/services/DeviceService";

// 查询所有指纹用户
deviceService.queryDoorlockUsers("finger");

// 监听查询结果
deviceService.on("doorlock_users_result", (type, data) => {
  console.log(`共查询到 ${data.total} 个用户`);

  data.data.forEach((user) => {
    console.log(`ID: ${user.user_id}, 名称: ${user.user_name}`);
  });
});
```

### 4.3 查询所有类型用户（分页）

```typescript
// 查询第 2 页，每页 20 条
deviceService.queryDoorlockUsers(undefined, 20, 20);

// 监听查询结果
deviceService.on("doorlock_users_result", (type, data) => {
  const { records, total, limit, offset } = data;

  console.log(`总数: ${total}, 当前页: ${records.length} 条`);
  console.log(`分页: ${offset}-${offset + limit}`);
});
```

## 五、向后兼容性

### 5.1 兼容性保证

✅ **完全向后兼容**

- `user_name` 参数为可选，不传时行为与旧版本一致
- 旧代码无需修改即可正常运行
- 新功能为增量添加，不影响现有功能

### 5.2 渐进式升级

可以按以下步骤逐步升级：

1. **第一阶段**：仅使用新的类型定义，不修改业务逻辑
2. **第二阶段**：在添加用户时开始使用 `user_name` 参数
3. **第三阶段**：使用 `queryDoorlockUsers` 接口替代旧的查询方式

## 六、注意事项

### 6.1 服务器端要求

- 服务器必须支持协议 v2.4
- 服务器需要实现 `user_name` 字段的存储
- 服务器需要实现 `doorlock_users` 查询接口

### 6.2 数据库要求

服务器端需要有 `doorlock_users` 表，包含以下字段：

- `id`: 主键
- `device_id`: 设备 MAC 地址
- `user_type`: 用户类型 (finger/nfc/password)
- `user_id`: ESP32 分配的用户 ID
- `user_name`: 用户备注名称
- `user_data`: 额外数据（如 NFC 卡号）
- `status`: 状态 (0=已删除, 1=正常)
- `created_at`: 创建时间
- `created_by`: 创建者 app_id

### 6.3 最佳实践

1. **添加用户时始终提供 user_name**

   ```typescript
   // ✅ 推荐
   service.sendUserMgmtCommand("finger", "add", 0, undefined, "张三的右手食指");

   // ❌ 不推荐（虽然可以工作）
   service.sendUserMgmtCommand("finger", "add", 0);
   ```

2. **定期查询用户列表以保持数据同步**

   ```typescript
   // 应用启动时查询
   deviceService.queryDoorlockUsers();

   // 添加用户后查询
   deviceService.on("finger_result", (type, data) => {
     if (data.result === "success") {
       deviceService.queryDoorlockUsers("finger");
     }
   });
   ```

3. **使用分页避免一次性加载过多数据**
   ```typescript
   // 每页 50 条
   const PAGE_SIZE = 50;
   deviceService.queryDoorlockUsers(undefined, PAGE_SIZE, page * PAGE_SIZE);
   ```

## 七、后续工作

### 7.1 UI 层面集成

需要在以下界面中集成新功能：

- [ ] 指纹管理界面：添加"备注名称"输入框
- [ ] NFC 管理界面：添加"备注名称"输入框
- [ ] 用户列表界面：显示用户备注名称
- [ ] 设置界面：添加"查看所有用户"入口

### 7.2 本地存储集成

考虑将查询到的用户列表缓存到本地存储：

```typescript
// 在 LocalStorageService 中添加
export interface StoredDoorlockUser {
  id: number;
  device_id: string;
  user_type: string;
  user_id: number;
  user_name: string;
  user_data?: string;
  status: number;
  created_at: string;
  created_by: string;
  cachedAt: number;
}
```

### 7.3 性能优化

- 实现用户列表的增量更新
- 添加用户列表的搜索和过滤功能
- 优化大量用户时的渲染性能

## 八、总结

本次协议 v2.4 升级成功实现了以下目标：

✅ **功能完整性**

- user_mgmt 命令完全支持 user_name 字段
- doorlock_users 查询接口功能完备

✅ **代码质量**

- 类型定义完整
- 方法实现规范
- 日志记录清晰

✅ **测试覆盖**

- 15 个测试用例全部通过
- 覆盖所有核心功能
- 包含集成测试

✅ **向后兼容**

- 不影响现有功能
- 支持渐进式升级
- 旧代码无需修改

本次升级为智能门锁 Pro 应用提供了更强大的用户管理能力，用户可以为每个指纹、NFC 卡片添加易读的备注名称，并通过统一的接口查询所有用户信息。

---

**文档维护者**: 毕业设计项目组  
**最后更新**: 2026-02-01
