# åè®®å‡çº§è®¡åˆ’ï¼šv2.3 â†’ v2.4

## ğŸ“‹ å‡çº§æ¦‚è¿°

**å‡çº§ç›®æ ‡**: å°†æ™ºèƒ½é—¨é” App ä»åè®® v2.3 å‡çº§åˆ° v2.4  
**å‡çº§æ—¥æœŸ**: 2026-01-31  
**å½±å“èŒƒå›´**: å‰ç«¯ App (TypeScript/React)  
**é¢„è®¡å·¥æ—¶**: 4-6 å°æ—¶

---

## ğŸ¯ æ ¸å¿ƒå˜æ›´ç‚¹

### 1. é”™è¯¯ç ä½“ç³»ç»Ÿä¸€ â­ æœ€é‡è¦

- **å˜æ›´**: `server_ack` é”™è¯¯ç ä» 0-5 ç®€åŒ–ä¸º 0/3/8/9
- **åŸå› **: æ˜ç¡® `server_ack` åªç”¨äºæ¥æ”¶ç¡®è®¤ï¼Œä¸šåŠ¡é”™è¯¯åœ¨ä¸šåŠ¡å“åº”ä¸­è¿”å›
- **å½±å“**: `DeviceService.ts` ä¸­çš„ `handleServerAck()` æ–¹æ³•

### 2. æ–°å¢å¯†ç æŸ¥è¯¢æ¥å£

- **å˜æ›´**: æ–°å¢ `query` æ¥å£çš„ `target: "password"` æ”¯æŒ
- **åŸå› **: æ›¿ä»£æ—§ç‰ˆé€šè¿‡ `user_mgmt` æŸ¥è¯¢å¯†ç çš„æ–¹å¼
- **å½±å“**: éœ€è¦æ·»åŠ æ–°çš„æŸ¥è¯¢å¤„ç†é€»è¾‘

### 3. åª’ä½“æ–‡ä»¶å¤§å°é™åˆ¶è¯´æ˜

- **å˜æ›´**: æ˜ç¡®æ–‡ä»¶ä¸‹è½½å¤§å°é™åˆ¶å’Œæ¨èç­–ç•¥
- **åŸå› **: ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼Œé¿å…å¤§æ–‡ä»¶ä¸‹è½½å¤±è´¥
- **å½±å“**: å¯é€‰ï¼Œå‰ç«¯å¯æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥å’Œæç¤º

### 4. éŸ³é¢‘è§£ç é”™è¯¯å¤„ç†

- **å˜æ›´**: æœåŠ¡å™¨ç«¯éŸ³é¢‘è§£ç é”™è¯¯å¤„ç†æœºåˆ¶
- **åŸå› **: æé«˜éŸ³é¢‘æµç¨³å®šæ€§
- **å½±å“**: å‰ç«¯æ— éœ€ä¿®æ”¹ï¼ˆæœåŠ¡å™¨ç«¯å®ç°ï¼‰

---

## ğŸ“ è¯¦ç»†ä¿®æ”¹ä»»åŠ¡

### ä»»åŠ¡ 1: ä¿®æ”¹ `server_ack` é”™è¯¯ç å¤„ç† â­ å¿…é¡»

**æ–‡ä»¶**: `services/DeviceService.ts`  
**æ–¹æ³•**: `handleServerAck()`  
**å½“å‰å®ç°**: å¤„ç† code 0-5  
**ç›®æ ‡å®ç°**: åªå¤„ç† code 0/3/8/9

#### ä¿®æ”¹å‰ï¼ˆv2.3ï¼‰

```typescript
switch (code) {
  case 0: // æˆåŠŸ - ç»§ç»­ç­‰å¾…
  case 1: // è®¾å¤‡ç¦»çº¿ - æ¸…ç†é˜Ÿåˆ—
  case 2: // å‚æ•°é”™è¯¯ - æ¸…ç†é˜Ÿåˆ—
  case 3: // æœªè®¤è¯ - æ¸…ç†é˜Ÿåˆ—
  case 4: // å†…éƒ¨é”™è¯¯ - æ¸…ç†é˜Ÿåˆ—
  case 5: // é‡å¤æ¶ˆæ¯ - æ¸…ç†é˜Ÿåˆ—ä½†ä¸è§¦å‘é”™è¯¯
}
```

#### ä¿®æ”¹åï¼ˆv2.4ï¼‰

```typescript
switch (code) {
  case 0: // æˆåŠŸ - ç»§ç»­ç­‰å¾… ESP32 ack
  case 3: // å‚æ•°é”™è¯¯ - æ¸…ç†é˜Ÿåˆ—
  case 8: // æœªè®¤è¯ - æ¸…ç†é˜Ÿåˆ—
  case 9: // é‡å¤æ¶ˆæ¯ - æ¸…ç†é˜Ÿåˆ—ä½†ä¸è§¦å‘é”™è¯¯
  default: // å…¶ä»–é”™è¯¯ç  - è®°å½•è­¦å‘Š
}
```

**å˜æ›´è¯´æ˜**:

- åˆ é™¤ code=1ï¼ˆè®¾å¤‡ç¦»çº¿ï¼‰å¤„ç† â†’ è®¾å¤‡çŠ¶æ€é”™è¯¯åº”åœ¨ `ack` ä¸­è¿”å›
- åˆ é™¤ code=2ï¼ˆå‚æ•°é”™è¯¯ï¼‰â†’ ç»Ÿä¸€ä½¿ç”¨ code=3
- åˆ é™¤ code=4ï¼ˆå†…éƒ¨é”™è¯¯ï¼‰â†’ ä¸šåŠ¡é”™è¯¯åœ¨ä¸šåŠ¡å“åº”ä¸­è¿”å›
- code=5ï¼ˆé‡å¤æ¶ˆæ¯ï¼‰æ”¹ä¸º code=9

**æµ‹è¯•å½±å“**:

- `test/DeviceService.test.ts` - éœ€è¦æ›´æ–°æµ‹è¯•ç”¨ä¾‹
- `test/timeoutRetry.test.ts` - éœ€è¦æ›´æ–° server_ack æµ‹è¯•
- `test/protocol-alignment-properties.test.ts` - éœ€è¦æ›´æ–°å±æ€§æµ‹è¯•
- `test/loggingEnhancement.test.ts` - éœ€è¦æ›´æ–°æ—¥å¿—æµ‹è¯•

---

### ä»»åŠ¡ 2: æ–°å¢å¯†ç æŸ¥è¯¢æ¥å£ â­ æ¨è

**æ–‡ä»¶**: `services/DeviceService.ts`  
**æ–°å¢æ–¹æ³•**: `queryPassword()`  
**æ–°å¢äº‹ä»¶**: `password_query_result`

#### å®ç°ä»£ç 

```typescript
/**
 * æŸ¥è¯¢è®¾å¤‡å¯†ç ï¼ˆä»æœåŠ¡å™¨æ•°æ®åº“æŸ¥è¯¢ï¼‰
 * åè®® v2.4 æ–°å¢æ¥å£
 */
public queryPassword(
  onSuccess?: (password: string) => void,
  onError?: (error: string) => void
): string | null {
  return this.sendCommand(
    {
      type: "query",
      target: "password",
    },
    {
      onSuccess: () => {
        // ç­‰å¾… query_result äº‹ä»¶
      },
      onError,
    }
  );
}
```

#### ä¿®æ”¹ `handleQueryResult()` æ–¹æ³•

```typescript
private handleQueryResult(msg: {
  type: string;
  target: string;
  status: string;
  data?: any;
  error?: string;
}) {
  const { target, status, data, error } = msg;

  // è§¦å‘ query_result äº‹ä»¶
  this.emit("query_result", msg);

  if (status === "success") {
    // æ–°å¢ï¼šå¤„ç†å¯†ç æŸ¥è¯¢ç»“æœ
    if (target === "password") {
      const password = data?.password || "123456";
      this.emit("password_query_result", { password });
      this.emit("log", {
        msg: "å¯†ç æŸ¥è¯¢æˆåŠŸ",
        type: "success",
      });
    }
    // ... å…¶ä»– target å¤„ç†
  } else {
    // é”™è¯¯å¤„ç†
    this.emit("log", {
      msg: `æŸ¥è¯¢å¤±è´¥: ${error}`,
      type: "error",
    });
  }
}
```

**UI é›†æˆ**:

- åœ¨ `SettingsScreen.tsx` ä¸­æ·»åŠ "æŸ¥è¯¢å¯†ç "æŒ‰é’®
- æ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼ˆé»˜è®¤å€¼ "123456"ï¼‰

---

### ä»»åŠ¡ 3: æ›´æ–°é”™è¯¯æ¶ˆæ¯æ˜ å°„ â­ æ¨è

**æ–‡ä»¶**: `services/DeviceService.ts`  
**æ–¹æ³•**: `getAckErrorMessage()`

#### ä¿®æ”¹è¯´æ˜

ç¡®ä¿é”™è¯¯ç  0-10 çš„æè¿°å‡†ç¡®ä¸”ç”¨æˆ·å‹å¥½ï¼š

```typescript
private getAckErrorMessage(code: number, defaultMsg: string): string {
  const errorMap: Record<number, string> = {
    0: "æˆåŠŸ",
    1: "è®¾å¤‡ç¦»çº¿ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥",
    2: "è®¾å¤‡å¿™ç¢Œï¼Œè¯·ç¨åé‡è¯•",
    3: "å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥",
    4: "è®¾å¤‡ä¸æ”¯æŒè¯¥æ“ä½œ",
    5: "æ“ä½œè¶…æ—¶ï¼Œè¯·é‡è¯•",
    6: "ç¡¬ä»¶æ•…éšœï¼Œè¯·è”ç³»ç»´ä¿®",
    7: "å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè¯·æ¸…ç†åé‡è¯•",
    8: "æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°è®¤è¯",
    9: "é‡å¤æ“ä½œï¼Œå·²å¿½ç•¥",
    10: "è®¾å¤‡å†…éƒ¨é”™è¯¯ï¼Œè¯·é‡å¯è®¾å¤‡",
  };
  return errorMap[code] || defaultMsg || `æœªçŸ¥é”™è¯¯ (code: ${code})`;
}
```

---

### ä»»åŠ¡ 4: æ·»åŠ åª’ä½“æ–‡ä»¶å¤§å°æ£€æŸ¥ ğŸ”µ å¯é€‰

**æ–‡ä»¶**: æ–°å»º `services/MediaDownloadService.ts` æˆ–åœ¨ç°æœ‰æœåŠ¡ä¸­æ·»åŠ 

#### å®ç°å»ºè®®

```typescript
/**
 * æ ¹æ®æ–‡ä»¶å¤§å°é€‰æ‹©ä¸‹è½½ç­–ç•¥
 * v2.4 åè®®å»ºè®®
 */
private getDownloadStrategy(fileSize: number): {
  method: "full" | "chunk";
  chunkSize?: number;
  warning?: string;
} {
  const MB = 1024 * 1024;

  if (fileSize < 5 * MB) {
    return { method: "full" };
  } else if (fileSize < 50 * MB) {
    return {
      method: "full",
      warning: "æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®ä½¿ç”¨åˆ†ç‰‡ä¸‹è½½",
    };
  } else if (fileSize < 100 * MB) {
    return {
      method: "chunk",
      chunkSize: 1 * MB,
    };
  } else {
    return {
      method: "chunk",
      chunkSize: 5 * MB,
    };
  }
}
```

**UI æç¤º**:

- æ–‡ä»¶ > 50MB: æ˜¾ç¤º"æ–‡ä»¶è¾ƒå¤§ï¼Œæ­£åœ¨åˆ†ç‰‡ä¸‹è½½..."
- æ–‡ä»¶ > 100MB: æ˜¾ç¤ºè¿›åº¦æ¡

---

### ä»»åŠ¡ 5: æ›´æ–°æµ‹è¯•ç”¨ä¾‹ â­ å¿…é¡»

#### 5.1 æ›´æ–° `test/DeviceService.test.ts`

**ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹**:

```typescript
describe("server_ack å¤„ç†", () => {
  it("server_ack code=0 æ—¶ç»§ç»­ç­‰å¾… ESP32 ack", () => {
    // ä¿æŒä¸å˜
  });

  it("server_ack code=3 æ—¶æ¸…ç†ç­‰å¾…é˜Ÿåˆ—ï¼ˆå‚æ•°é”™è¯¯ï¼‰", () => {
    // åŸ code=2 æ”¹ä¸º code=3
  });

  it("server_ack code=8 æ—¶æ¸…ç†ç­‰å¾…é˜Ÿåˆ—ï¼ˆæœªè®¤è¯ï¼‰", () => {
    // åŸ code=3 æ”¹ä¸º code=8
  });

  it("server_ack code=9 æ—¶æ¸…ç†é˜Ÿåˆ—ä½†ä¸è§¦å‘é”™è¯¯ï¼ˆé‡å¤æ¶ˆæ¯ï¼‰", () => {
    // åŸ code=5 æ”¹ä¸º code=9
  });

  // åˆ é™¤ code=1ï¼ˆè®¾å¤‡ç¦»çº¿ï¼‰å’Œ code=4ï¼ˆå†…éƒ¨é”™è¯¯ï¼‰çš„æµ‹è¯•
});
```

#### 5.2 æ›´æ–° `test/timeoutRetry.test.ts`

**ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹**:

```typescript
describe("server_ack å“åº”å¤„ç†", () => {
  it("æ”¶åˆ° server_ack (code=0) ååº”è¯¥ç»§ç»­ç­‰å¾… ack", async () => {
    // ä¿æŒä¸å˜
  });

  it("æ”¶åˆ° server_ack (code=3) ååº”è¯¥æ¸…ç†ç­‰å¾…é˜Ÿåˆ—", async () => {
    // åŸ code=1 æ”¹ä¸º code=3
  });

  it("æ”¶åˆ° server_ack (code=9) ååº”è¯¥æ¸…ç†é˜Ÿåˆ—ä½†ä¸è§¦å‘é”™è¯¯", async () => {
    // åŸ code=5 æ”¹ä¸º code=9
  });
});
```

#### 5.3 æ›´æ–° `test/protocol-alignment-properties.test.ts`

**ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹**:

```typescript
describe("19.4 æµ‹è¯• server_ack å¤„ç†æ­£ç¡®æ€§ï¼ˆå±æ€§ 4ï¼‰", () => {
  it("æ”¶åˆ° server_ack (code=0)ï¼ŒéªŒè¯å‘½ä»¤ä»åœ¨é˜Ÿåˆ—ä¸­", () => {
    // ä¿æŒä¸å˜
  });

  it("æ”¶åˆ° server_ack (code=3)ï¼ŒéªŒè¯å‘½ä»¤è¢«ç§»é™¤ä¸”è§¦å‘é”™è¯¯å›è°ƒ", () => {
    // åŸ code=1 æ”¹ä¸º code=3
  });

  it("æ”¶åˆ° server_ack (code=9)ï¼ŒéªŒè¯å‘½ä»¤è¢«ç§»é™¤ä½†ä¸è§¦å‘é”™è¯¯å›è°ƒ", () => {
    // åŸ code=5 æ”¹ä¸º code=9
  });
});
```

#### 5.4 æ›´æ–° `test/loggingEnhancement.test.ts`

**ä¿®æ”¹æµ‹è¯•ç”¨ä¾‹**:

```typescript
it("åº”è¯¥åœ¨æ”¶åˆ° server_ack æ—¶è®°å½• type, seq_id, code", () => {
  // æ›´æ–°æµ‹è¯•ä¸­çš„ code å€¼ä¸º 0/3/8/9
});
```

#### 5.5 æ–°å¢å¯†ç æŸ¥è¯¢æµ‹è¯•

**æ–°å»ºæµ‹è¯•æ–‡ä»¶**: `test/passwordQuery.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from "vitest";
import { DeviceService } from "@/services/DeviceService";

describe("å¯†ç æŸ¥è¯¢åŠŸèƒ½ (v2.4)", () => {
  let service: DeviceService;

  beforeEach(() => {
    service = new DeviceService();
  });

  it("åº”è¯¥å‘é€ query å‘½ä»¤æŸ¥è¯¢å¯†ç ", () => {
    const seqId = service.queryPassword();
    expect(seqId).toBeTruthy();
  });

  it("åº”è¯¥å¤„ç†å¯†ç æŸ¥è¯¢æˆåŠŸå“åº”", () => {
    const onPasswordResult = vi.fn();
    service.on("password_query_result", onPasswordResult);

    // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”
    (service as any).handleQueryResult({
      type: "query_result",
      target: "password",
      status: "success",
      data: { password: "654321" },
    });

    expect(onPasswordResult).toHaveBeenCalledWith("password_query_result", {
      password: "654321",
    });
  });

  it("å¯†ç ä¸å­˜åœ¨æ—¶åº”è¯¥è¿”å›é»˜è®¤å€¼ 123456", () => {
    const onPasswordResult = vi.fn();
    service.on("password_query_result", onPasswordResult);

    // æ¨¡æ‹ŸæœåŠ¡å™¨å“åº”ï¼ˆæ— å¯†ç ï¼‰
    (service as any).handleQueryResult({
      type: "query_result",
      target: "password",
      status: "success",
      data: { password: "123456" },
    });

    expect(onPasswordResult).toHaveBeenCalledWith("password_query_result", {
      password: "123456",
    });
  });
});
```

---

### ä»»åŠ¡ 6: æ›´æ–°ç±»å‹å®šä¹‰ ğŸ”µ å¯é€‰

**æ–‡ä»¶**: `types.ts`

#### æ–°å¢ç±»å‹

```typescript
// å¯†ç æŸ¥è¯¢ç»“æœ
export interface PasswordQueryResult {
  password: string;
}

// åª’ä½“ä¸‹è½½ç­–ç•¥
export interface MediaDownloadStrategy {
  method: "full" | "chunk";
  chunkSize?: number;
  warning?: string;
}
```

---

### ä»»åŠ¡ 7: æ›´æ–°æ–‡æ¡£æ³¨é‡Š ğŸ”µ å¯é€‰

**æ–‡ä»¶**: `services/DeviceService.ts`

#### æ›´æ–°æ–¹æ³•æ³¨é‡Š

```typescript
/**
 * å¤„ç† server_ack æ¶ˆæ¯
 * åè®® v2.4 è§„èŒƒï¼šåªç”¨äºæ¥æ”¶ç¡®è®¤ï¼Œä¸æ¶‰åŠä¸šåŠ¡é€»è¾‘
 *
 * code=0: æœåŠ¡å™¨å·²æ”¶åˆ°ï¼Œç»§ç»­ç­‰å¾… ack
 * code=3: å‚æ•°é”™è¯¯ï¼Œæ¸…ç†é˜Ÿåˆ—å¹¶è§¦å‘é”™è¯¯
 * code=8: æœªè®¤è¯ï¼Œæ¸…ç†é˜Ÿåˆ—å¹¶è§¦å‘é”™è¯¯
 * code=9: é‡å¤æ¶ˆæ¯ï¼Œæ¸…ç†é˜Ÿåˆ—ä½†ä¸è§¦å‘é”™è¯¯
 *
 * æ³¨æ„ï¼šè®¾å¤‡çŠ¶æ€é”™è¯¯ï¼ˆå¦‚è®¾å¤‡ç¦»çº¿ã€è®¾å¤‡å¿™ï¼‰åº”åœ¨ ack å“åº”ä¸­è¿”å›
 */
private handleServerAck(msg: { ... }) {
  // ...
}
```

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

```bash
npm run test -- test/DeviceService.test.ts
npm run test -- test/timeoutRetry.test.ts
npm run test -- test/protocol-alignment-properties.test.ts
npm run test -- test/loggingEnhancement.test.ts
npm run test -- test/passwordQuery.test.ts
```

### é›†æˆæµ‹è¯•

1. **server_ack é”™è¯¯ç æµ‹è¯•**
   - å‘é€å‘½ä»¤ï¼Œæ¨¡æ‹Ÿ server_ack code=0/3/8/9
   - éªŒè¯é˜Ÿåˆ—çŠ¶æ€å’Œå›è°ƒè§¦å‘

2. **å¯†ç æŸ¥è¯¢æµ‹è¯•**
   - è°ƒç”¨ `queryPassword()`
   - éªŒè¯è¿”å›å¯†ç æˆ–é»˜è®¤å€¼ "123456"

3. **é”™è¯¯å¤„ç†æµ‹è¯•**
   - æ¨¡æ‹Ÿå„ç§é”™è¯¯åœºæ™¯
   - éªŒè¯é”™è¯¯æ¶ˆæ¯å‡†ç¡®æ€§

### æ‰‹åŠ¨æµ‹è¯•

1. è¿æ¥çœŸå®è®¾å¤‡
2. å‘é€å„ç±»å‘½ä»¤ï¼Œè§‚å¯Ÿ server_ack å“åº”
3. æŸ¥è¯¢å¯†ç ï¼ŒéªŒè¯ç»“æœ
4. ä¸‹è½½ä¸åŒå¤§å°çš„åª’ä½“æ–‡ä»¶

---

## ğŸ“Š å·¥ä½œé‡è¯„ä¼°

| ä»»åŠ¡                         | ä¼˜å…ˆçº§  | é¢„è®¡å·¥æ—¶ | éš¾åº¦ |
| ---------------------------- | ------- | -------- | ---- |
| ä»»åŠ¡ 1: ä¿®æ”¹ server_ack å¤„ç† | â­ å¿…é¡» | 1h       | ä¸­   |
| ä»»åŠ¡ 2: æ–°å¢å¯†ç æŸ¥è¯¢æ¥å£     | â­ æ¨è | 1.5h     | ä¸­   |
| ä»»åŠ¡ 3: æ›´æ–°é”™è¯¯æ¶ˆæ¯æ˜ å°„     | â­ æ¨è | 0.5h     | ä½   |
| ä»»åŠ¡ 4: æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥     | ğŸ”µ å¯é€‰ | 1h       | ä½   |
| ä»»åŠ¡ 5: æ›´æ–°æµ‹è¯•ç”¨ä¾‹         | â­ å¿…é¡» | 2h       | ä¸­   |
| ä»»åŠ¡ 6: æ›´æ–°ç±»å‹å®šä¹‰         | ğŸ”µ å¯é€‰ | 0.5h     | ä½   |
| ä»»åŠ¡ 7: æ›´æ–°æ–‡æ¡£æ³¨é‡Š         | ğŸ”µ å¯é€‰ | 0.5h     | ä½   |
| **æ€»è®¡**                     | -       | **4-7h** | -    |

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ä¿®æ”¹ï¼ˆå¿…é¡»ï¼‰

1. âœ… ä¿®æ”¹ `handleServerAck()` æ–¹æ³•ï¼ˆä»»åŠ¡ 1ï¼‰
2. âœ… æ›´æ–°é”™è¯¯æ¶ˆæ¯æ˜ å°„ï¼ˆä»»åŠ¡ 3ï¼‰
3. âœ… æ›´æ–°æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼ˆä»»åŠ¡ 5ï¼‰
4. âœ… è¿è¡Œæµ‹è¯•ï¼Œç¡®ä¿é€šè¿‡

### ç¬¬äºŒé˜¶æ®µï¼šæ–°åŠŸèƒ½æ·»åŠ ï¼ˆæ¨èï¼‰

1. âœ… å®ç°å¯†ç æŸ¥è¯¢æ¥å£ï¼ˆä»»åŠ¡ 2ï¼‰
2. âœ… æ·»åŠ å¯†ç æŸ¥è¯¢æµ‹è¯•
3. âœ… åœ¨ UI ä¸­é›†æˆå¯†ç æŸ¥è¯¢åŠŸèƒ½

### ç¬¬ä¸‰é˜¶æ®µï¼šä¼˜åŒ–å¢å¼ºï¼ˆå¯é€‰ï¼‰

1. ğŸ”µ æ·»åŠ æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆä»»åŠ¡ 4ï¼‰
2. ğŸ”µ æ›´æ–°ç±»å‹å®šä¹‰ï¼ˆä»»åŠ¡ 6ï¼‰
3. ğŸ”µ å®Œå–„æ–‡æ¡£æ³¨é‡Šï¼ˆä»»åŠ¡ 7ï¼‰

---

## âš ï¸ é£é™©ä¸æ³¨æ„äº‹é¡¹

### å…¼å®¹æ€§é£é™©

- **æœåŠ¡å™¨ç«¯æœªå‡çº§**: å¦‚æœæœåŠ¡å™¨ä»è¿”å› code=1/2/4/5ï¼Œå‰ç«¯éœ€è¦å…¼å®¹å¤„ç†
- **å»ºè®®**: åœ¨ `handleServerAck()` ä¸­æ·»åŠ é™çº§å¤„ç†

```typescript
switch (code) {
  case 0: // v2.4
  case 3: // v2.4
  case 8: // v2.4
  case 9: // v2.4
    // æ­£å¸¸å¤„ç†
    break;

  // å…¼å®¹ v2.3
  case 1: // v2.3 è®¾å¤‡ç¦»çº¿
  case 2: // v2.3 å‚æ•°é”™è¯¯
  case 4: // v2.3 å†…éƒ¨é”™è¯¯
  case 5: // v2.3 é‡å¤æ¶ˆæ¯
    this.emit("log", {
      msg: `æ”¶åˆ°æ—§ç‰ˆé”™è¯¯ç  ${code}ï¼Œå»ºè®®å‡çº§æœåŠ¡å™¨åˆ° v2.4`,
      type: "warning",
    });
    // æŒ‰æ—§é€»è¾‘å¤„ç†
    break;
}
```

### æµ‹è¯•è¦†ç›–

- ç¡®ä¿æ‰€æœ‰ä¿®æ”¹çš„ä»£ç éƒ½æœ‰å¯¹åº”æµ‹è¯•
- æµ‹è¯•è¦†ç›–ç‡åº”ä¿æŒåœ¨ 80% ä»¥ä¸Š

### å›æ»šè®¡åˆ’

- ä¿ç•™ v2.3 åˆ†æ”¯ï¼š`git checkout -b backup-v2.3`
- å¦‚æœå‡çº§å¤±è´¥ï¼Œå¯å¿«é€Ÿå›æ»š

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [åè®®è§„èŒƒ v2.3](./æ™ºèƒ½çŒ«çœ¼é—¨é”ç³»ç»Ÿ-æœåŠ¡å™¨ä¸Appé€šä¿¡åè®®è§„èŒƒ-v2.3.md)
- [åè®®è§„èŒƒ v2.4](./æ™ºèƒ½çŒ«çœ¼é—¨é”ç³»ç»Ÿ-æœåŠ¡å™¨ä¸Appé€šä¿¡åè®®è§„èŒƒ-v2.4.md)
- [åè®®æ›´æ–°æ€»ç»“](./åè®®æ›´æ–°æ€»ç»“-v2.4.md)

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
2. âœ… `server_ack` åªå¤„ç† code 0/3/8/9
3. âœ… å¯†ç æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
4. âœ… é”™è¯¯æ¶ˆæ¯å‡†ç¡®ä¸”ç”¨æˆ·å‹å¥½
5. âœ… ä»£ç æ³¨é‡Šæ¸…æ™°å®Œæ•´
6. âœ… æ—  TypeScript ç±»å‹é”™è¯¯
7. âœ… ä¸çœŸå®è®¾å¤‡æµ‹è¯•é€šè¿‡

---

**åˆ¶å®šäºº**: Kiro AI  
**åˆ¶å®šæ—¥æœŸ**: 2026-01-31  
**ç‰ˆæœ¬**: 1.0
