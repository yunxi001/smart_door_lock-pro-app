# 智能门锁 Pro - 项目技术文档

## 1. 项目概述

智能门锁 Pro 是一款移动优先的 Web 应用，用于控制和监控智能猫眼门锁系统。该应用通过 WebSocket 与后端服务器通信，实现对 ESP32 智能门锁设备的远程控制和实时监控。

### 1.1 核心特性

| 功能模块 | 描述 | 技术实现 |
|---------|------|----------|
| 实时监控 | 门锁摄像头视频流 + FPS 统计 | JPEG 帧通过 WebSocket 二进制传输 |
| 双向对讲 | 与访客语音通话 | PCM 音频 (接收 16kHz / 发送 24kHz) |
| 人脸管理 | 注册、列表、删除、权限编辑 | Base64 图片 + 多种权限类型 |
| 指纹管理 | 录入、列表、删除指纹 | 设备端指纹传感器交互 |
| NFC 卡片管理 | 绑定、列表、删除 NFC 卡片 | 卡号脱敏显示 |
| 密码管理 | 管理员密码、临时密码管理 | 多种临时密码类型 |
| 到访记录 | 访客历史及开门/拒绝状态 | 实时推送通知 |
| 设备控制 | 远程开锁/关锁、补光灯、门铃 | WebSocket 命令代理 |
| 本地持久化 | 设备状态离线缓存 | IndexedDB 存储 |

### 1.2 目标用户

家庭用户，管理智能门锁设备。UI 全中文，移动端优先设计。

---

## 2. 技术栈

### 2.1 核心技术

| 类别 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 构建工具 | Vite | 6.x | 开发服务器端口 3000 |
| 类型系统 | TypeScript | 5.8 | 严格类型检查 |
| UI 框架 | React | 19 | 函数式组件 + Hooks |
| 样式 | Tailwind CSS | CDN | 原子化 CSS |
| 图标 | Lucide React | 0.556 | 统一图标库 |
| 测试 | Vitest + fast-check | 4.x | 单元测试 + 属性测试 |

### 2.2 浏览器 API

- **WebSocket**: 门锁设备通信，自定义二进制协议
- **Web Audio API**: PCM 音频播放 (16kHz) 和采集 (24kHz)
- **MediaDevices API**: 麦克风访问，需 HTTPS 或 localhost
- **IndexedDB**: 设备状态本地持久化存储

---

## 3. 项目结构

```
智能门锁-pro/
├── App.tsx                    # 根组件：全局状态管理、事件订阅
├── index.tsx                  # React 入口
├── index.html                 # HTML 模板 (含 Tailwind CDN)
├── types.ts                   # 共享 TypeScript 类型定义
├── vite.config.ts             # Vite 构建配置
├── tsconfig.json              # TypeScript 配置
├── package.json               # 项目依赖
│
├── components/                # 可复用 UI 组件
│   ├── BottomNav.tsx          # 底部导航栏
│   └── VisitNotificationModal.tsx  # 到访通知弹窗
│
├── screens/                   # 页面级组件 (每个 Tab 一个)
│   ├── HomeScreen.tsx         # 首页：设备状态、快捷操作、最近动态
│   ├── MonitorScreen.tsx      # 监控页：视频流、对讲功能
│   └── SettingsScreen.tsx     # 设置页：用户管理、记录查询、连接配置
│
├── services/                  # 业务逻辑与外部通信
│   ├── DeviceService.ts       # WebSocket 通信、音频处理
│   ├── DeviceStatusStorageService.ts  # 设备状态本地持久化
│   └── VideoStorageService.ts # 视频文件本地存储
│
├── test/                      # 测试文件
│   ├── setup.ts               # 测试环境配置
│   ├── DeviceService.test.ts  # DeviceService 测试
│   ├── components.test.ts     # UI 组件测试
│   ├── faceManagement.test.ts # 人脸管理测试
│   ├── fingerprintManagement.test.ts  # 指纹管理测试
│   ├── nfcManagement.test.ts  # NFC 卡片测试
│   ├── passwordManagement.test.ts     # 密码管理测试
│   ├── mediaDownload.test.ts  # 媒体下载测试
│   ├── binaryProtocol.test.ts # 二进制协议测试
│   └── deviceStatusStorage.test.ts    # 本地存储测试
│
└── .kiro/                     # Kiro IDE 配置
    ├── specs/                 # 功能规格文档
    └── steering/              # 项目规范指南
```

---

## 4. 架构设计

### 4.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        App.tsx                               │
│                   (全局状态管理中心)                          │
├─────────────────────────────────────────────────────────────┤
│  状态: status, deviceStatus, persons, visits, logs, etc.    │
│  事件订阅: deviceService.on('event', handler)               │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ props
                              ▼
┌─────────────┬─────────────┬─────────────┐
│ HomeScreen  │MonitorScreen│SettingsScreen│
│   (首页)    │   (监控)    │   (设置)     │
└─────────────┴─────────────┴─────────────┘
                              │
                              │ 调用
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     DeviceService                            │
│                   (单例通信服务)                              │
├─────────────────────────────────────────────────────────────┤
│  WebSocket 连接管理                                          │
│  消息发送/接收                                               │
│  音频播放/采集                                               │
│  事件分发                                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Server                                  │
│                   (后端服务器)                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      ESP32                                   │
│                   (智能门锁设备)                              │
└─────────────────────────────────────────────────────────────┘
```

### 4.2 设计模式

| 模式 | 说明 | 示例 |
|------|------|------|
| 单例服务 | `deviceService` 全局唯一实例 | `import { deviceService } from '@/services/DeviceService'` |
| 事件驱动 | 组件通过 `deviceService.on()` 订阅事件 | `deviceService.on('status', handler)` |
| 集中状态 | App.tsx 持有共享状态 | 通过 props 向下传递 |
| Tab 导航 | `currentTab` 控制三个主屏幕切换 | home / monitor / settings |

---

## 5. 数据流

### 5.1 状态管理流程

```
DeviceService (事件源)
       │
       │ emit('event', data)
       ▼
   App.tsx (状态持有者)
       │
       │ useState + useEffect
       │ 订阅事件、更新状态
       ▼
   Screen 组件 (展示层)
       │
       │ props 接收状态
       │ 调用回调函数
       ▼
   用户交互
```

### 5.2 WebSocket 通信流程

#### 连接认证流程

```
App                          Server                      ESP32
 │                              │                           │
 │──── WebSocket 连接 ─────────►│                           │
 │                              │                           │
 │──── hello 消息 ─────────────►│                           │
 │     {type: "hello",          │ 验证 device_id            │
 │      device_id: "AA:BB:...", │ 检查 ESP32 是否在线       │
 │      client_type: "app"}     │                           │
 │                              │                           │
 │◄─── hello 响应 ─────────────│                           │
 │     {status: "ok",           │                           │
 │      device_info: {...}}     │                           │
```

#### 命令代理流程

```
App                          Server                      ESP32
 │                              │                           │
 │── lock_control ─────────────►│                           │
 │   {type: "lock_control",     │                           │
 │    seq_id: "app_xxx_001",    │                           │
 │    command: "unlock"}        │                           │
 │                              │                           │
 │◄── server_ack ──────────────│ (code=0, 已接收)          │
 │                              │                           │
 │                              │── lock_control ──────────►│
 │                              │                           │
 │                              │◄───── ack ───────────────│
 │◄── ack ─────────────────────│ (ESP32 执行结果)          │
```

#### 状态推送流程

```
App                          Server                      ESP32
 │                              │                           │
 │                              │◄── status_report ────────│
 │                              │   {bat: 85, lock: 0, ...} │
 │                              │                           │
 │◄── status_report ───────────│ (转发给所有 App)          │
 │                              │                           │
 │   更新 deviceStatus 状态     │                           │
 │   保存到 IndexedDB           │                           │
```

### 5.3 音视频流

#### 视频流 (Server → App)

| 参数 | 值 |
|------|-----|
| 格式 | JPEG 图像序列 |
| 分辨率 | 640×480 |
| 帧率 | 约 10 fps |
| 传输方式 | WebSocket 二进制帧 |

#### 音频流 (双向)

| 方向 | 格式 | 采样率 | 声道 | 位深 |
|------|------|--------|------|------|
| Server → App | PCM | 16kHz | 单声道 | 16-bit |
| App → Server | PCM | 24kHz | 单声道 | 16-bit |

---

## 6. UI 界面

### 6.1 页面结构

应用采用三 Tab 布局，通过底部导航栏切换：

```
┌─────────────────────────────────────┐
│           顶部标题栏                 │
│   智能门锁 Pro        [连接状态]     │
├─────────────────────────────────────┤
│                                     │
│                                     │
│           主内容区域                 │
│                                     │
│   (HomeScreen / MonitorScreen /     │
│    SettingsScreen)                  │
│                                     │
│                                     │
├─────────────────────────────────────┤
│   [首页]    [监控]    [设置]        │
│           底部导航栏                 │
└─────────────────────────────────────┘
```

### 6.2 首页 (HomeScreen)

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐    │
│  │ 📶 设备在线    🔋 85%       │    │
│  │ 上次更新: 2024-12-24 10:30  │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         🔓                   │    │
│  │       已锁定                 │    │
│  │      点击开锁                │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 快捷功能                     │    │
│  │ [临时密码] [补光灯] [门铃]   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 最近动态                     │    │
│  │ • 人脸识别 - 开锁成功        │    │
│  │ • 有人按门铃                 │    │
│  │ • 检测到移动                 │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

**功能说明：**
- 设备状态卡片：显示连接状态、电量、离线时显示上次更新时间
- 开锁按钮：大圆形按钮，点击开锁/关锁
- 快捷功能：临时密码生成、补光灯控制、门铃测试
- 最近动态：显示最近 3 条到访/开锁/事件记录

### 6.3 监控页 (MonitorScreen)

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐    │
│  │ [LIVE]              10 FPS  │    │
│  │                             │    │
│  │      实时视频画面            │    │
│  │                             │    │
│  │                    1.2 KB   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌──────────┐  ┌──────────┐        │
│  │ ▶ 开启监控│  │ ■ 停止   │        │
│  └──────────┘  └──────────┘        │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 音画对讲                     │    │
│  │                             │    │
│  │  ┌────┐   🔊 ━━━━━━━ 80%   │    │
│  │  │ 🎤 │                     │    │
│  │  │对讲│   注意: 需要 HTTPS  │    │
│  │  └────┘   环境才能使用麦克风 │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

**功能说明：**
- 视频区域：显示实时 JPEG 视频流，左上角 LIVE 指示灯，右上角 FPS 和数据量统计
- 控制按钮：开启/停止监控
- 对讲功能：按住对讲按钮发送语音，音量滑块控制接收音量

### 6.4 设置页 (SettingsScreen)

```
┌─────────────────────────────────────┐
│  ┌─────────────────────────────┐    │
│  │ 连接配置                     │    │
│  │ 服务器: ws://localhost:8000 │    │
│  │ 设备ID: AA:BB:CC:DD:EE:FF   │    │
│  │ [连接服务器]                 │    │
│  └─────────────────────────────┘    │
│                                     │
│  用户管理                           │
│  ├─ 👤 人脸管理 ─────────────► │    │
│  ├─ 🖐 指纹管理 ─────────────► │    │
│  ├─ 💳 NFC 卡片管理 ─────────► │    │
│  └─ 🔑 密码管理 ─────────────► │    │
│                                     │
│  记录查询                           │
│  ├─ 📋 开锁记录 ─────────────► │    │
│  ├─ 📢 事件记录 ─────────────► │    │
│  └─ 👥 到访记录 ─────────────► │    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │ 系统日志                     │    │
│  │ [10:30:01] 连接成功          │    │
│  │ [10:30:02] 认证通过          │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

**子页面：**

1. **人脸管理**
   - 人员列表：显示已注册人员，支持编辑权限、删除
   - 录入人脸：上传照片、填写姓名、选择关系类型、设置权限时段

2. **指纹管理**
   - 指纹列表：显示已录入指纹，支持删除
   - 添加指纹：输入名称，引导用户在设备上录入

3. **NFC 卡片管理**
   - 卡片列表：显示已绑定卡片（卡号脱敏），支持删除
   - 添加卡片：输入名称，引导用户刷卡绑定

4. **密码管理**
   - 管理员密码：修改 6 位数字密码
   - 临时密码：创建一次性/限时/限次密码

5. **记录查询**
   - 开锁记录：分页显示，支持视频附件下载
   - 事件记录：门铃、移动检测、撬锁报警等
   - 到访记录：人脸识别结果、是否开门

### 6.5 弹窗组件

#### 到访通知弹窗

```
┌─────────────────────────────────────┐
│  📷 到访通知                    ✕   │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │       抓拍图片               │    │
│  │                    [已识别] │    │
│  └─────────────────────────────┘    │
│                                     │
│  👤 张三                            │
│     家人                            │
│                                     │
│  ┌─────────────────────────────┐    │
│  │      ✓ 已开门                │    │
│  └─────────────────────────────┘    │
│                                     │
│  2024-12-24 10:30:00               │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         知道了               │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

#### 权限编辑弹窗

```
┌─────────────────────────────────────┐
│  编辑权限 - 张三                    │
├─────────────────────────────────────┤
│  权限类型                           │
│  [永久] [临时] [限次]               │
│                                     │
│  每日允许时段                       │
│  [08:00] 至 [22:00]                │
│                                     │
│  有效期 (临时权限)                  │
│  [2024-12-01] 至 [2024-12-31]      │
│                                     │
│  剩余次数 (限次权限)                │
│  [10]                              │
│                                     │
│  ┌──────────┐  ┌──────────┐        │
│  │   取消   │  │   保存   │        │
│  └──────────┘  └──────────┘        │
└─────────────────────────────────────┘
```

---

## 7. 功能模块详解

### 7.1 设备连接

**连接流程：**
1. 用户输入服务器地址和设备 ID
2. 建立 WebSocket 连接
3. 发送 `hello` 认证消息
4. 接收认证响应，更新连接状态
5. 初始化音频系统

**消息确认机制：**
- 每条命令自动附加 `seq_id`
- 服务器返回 `server_ack` 确认
- 支持重传和防重放

### 7.2 人脸管理

**权限类型：**
| 类型 | 说明 | 额外字段 |
|------|------|----------|
| permanent | 永久权限 | time_start, time_end |
| temporary | 临时权限 | valid_from, valid_until, time_start, time_end |
| count_limited | 限次权限 | remaining_count, time_start, time_end |

**命令格式：**
```json
{
  "type": "face_management",
  "action": "update_permission",
  "data": {
    "person_id": 5,
    "permission": {
      "permission_type": "temporary",
      "valid_from": "2024-12-01",
      "valid_until": "2024-12-31",
      "time_start": "08:00",
      "time_end": "22:00"
    }
  }
}
```

### 7.3 本地持久化

**IndexedDB 存储结构：**
```typescript
interface LocalDeviceStatus {
  deviceId: string;      // 设备 ID (主键)
  battery: number;       // 电量
  lux: number;           // 光照值
  lockState: number;     // 锁状态
  lightState: number;    // 补光灯状态
  lastUpdate: number;    // 最后更新时间戳
}
```

**使用场景：**
- 应用启动时加载缓存的设备状态
- 设备离线时显示上次已知状态
- 收到状态上报时自动保存

---

## 8. 测试覆盖

### 8.1 测试框架

- **Vitest**: 测试运行器
- **fast-check**: 属性测试库
- **@testing-library/react**: React 组件测试

### 8.2 测试文件

| 文件 | 测试内容 | 测试数量 |
|------|----------|----------|
| DeviceService.test.ts | WebSocket 通信、事件处理 | 28 |
| components.test.ts | UI 组件逻辑 | 12 |
| faceManagement.test.ts | 人脸管理、权限编辑 | 12 |
| fingerprintManagement.test.ts | 指纹管理 | 12 |
| nfcManagement.test.ts | NFC 卡片管理 | 16 |
| passwordManagement.test.ts | 密码管理 | 11 |
| mediaDownload.test.ts | 媒体下载 | 11 |
| binaryProtocol.test.ts | 二进制协议解析 | 7 |
| deviceStatusStorage.test.ts | 本地存储 | 5 |

**总计: 114 个测试用例**

### 8.3 运行测试

```bash
# 运行所有测试
npm test

# 监听模式
npm run test:watch
```

---

## 9. 开发指南

### 9.1 环境要求

- Node.js 18+
- npm 或 yarn

### 9.2 安装依赖

```bash
npm install
```

### 9.3 开发服务器

```bash
npm run dev
# 访问 http://localhost:3000
```

### 9.4 生产构建

```bash
npm run build
npm run preview
```

### 9.5 环境变量

在 `.env.local` 中配置：
```
GEMINI_API_KEY=your_api_key
```

---

## 10. 协议规范

详细的通信协议规范请参考：
- `智能猫眼门锁系统-服务器与App通信协议规范-v2.2.md`

### 10.1 消息类型汇总

**App 发送的消息：**
| type | 说明 |
|------|------|
| hello | 连接认证 |
| lock_control | 锁控命令 |
| dev_control | 设备控制 |
| user_mgmt | 用户管理 |
| system | 系统命令 |
| face_management | 人脸管理 |
| query | 数据查询 |
| media_download | 媒体下载 |

**Server 推送的消息：**
| type | 说明 |
|------|------|
| server_ack | 消息确认 |
| device_status | 设备上下线 |
| status_report | 状态上报 |
| event_report | 事件上报 |
| log_report | 开锁日志 |
| visit_notification | 到访通知 |
| query_result | 查询结果 |

---

## 11. 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 2.0.2 | 2024-12-24 | 新增人脸权限编辑功能；新增设备状态本地持久化 |
| 2.0.1 | 2024-12-23 | 新增视频附件下载功能 |
| 2.0.0 | 2024-12-22 | 重构为三 Tab 布局；新增指纹/NFC/密码管理 |
| 1.0.0 | 2024-12-20 | 初始版本 |

---

**文档维护者：** 智能门锁 Pro 开发团队  
**最后更新：** 2024-12-24
