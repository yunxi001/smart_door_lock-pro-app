<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# 智能门锁 Pro

智能门锁 Pro 是一款移动优先的 Web 应用，用于控制和监控智能猫眼门锁系统。

View your app in AI Studio: https://ai.studio/apps/drive/1QDTRxYj2_XU-pTXRu9JhAlM7bQ1ER0sg

## 核心功能

- **实时监控**: 门锁摄像头视频流 + FPS 统计
- **双向对讲**: 与访客语音通话
- **人脸管理**: 注册、列表、删除授权人员
- **指纹管理**: 添加、查询、删除指纹记录
- **NFC 卡片管理**: 添加、查询、删除 NFC 卡片
- **临时密码**: 创建和管理临时访问密码
- **到访记录**: 访客历史及开门/拒绝状态
- **本地持久化**: 离线缓存和快速启动
- **主题切换**: 支持浅色和深色两种主题模式

## 本地持久化存储

应用使用 IndexedDB 实现完整的本地持久化存储，提供以下能力：

### 功能特性

- **快速启动**: 应用启动时立即显示缓存数据，无需等待网络请求
- **离线查看**: 支持离线浏览已缓存的历史记录和业务数据
- **自动同步**: 连接服务器后自动同步最新数据
- **智能清理**: 自动清理过期数据，避免占用过多存储空间
- **容错降级**: IndexedDB 不可用时自动降级到纯内存模式

### 存储的数据类型

| 数据类型 | 说明                 | 清理策略            |
| -------- | -------------------- | ------------------- |
| 人脸列表 | 已注册的人脸信息     | 无自动清理          |
| 指纹列表 | 已注册的指纹信息     | 无自动清理          |
| NFC 卡片 | 已注册的 NFC 卡片    | 无自动清理          |
| 临时密码 | 临时访问密码列表     | 无自动清理          |
| 开锁记录 | 历史开锁日志         | 30 天或 500 条      |
| 事件记录 | 门铃、移动检测等事件 | 30 天或 500 条      |
| 到访记录 | 访客到访历史         | 30 天或 200 条      |
| 最近动态 | 首页动态列表         | 最多 50 条          |
| 应用设置 | 用户偏好设置         | 无自动清理          |
| 设备状态 | 设备在线状态         | 无自动清理          |
| 视频文件 | 下载的视频记录       | 1GB 容量限制 (FIFO) |

### 存储配额

- **总容量**: 取决于浏览器和设备可用空间（通常至少 50MB）
- **视频文件**: 限制为 1GB，超过后按 FIFO 策略删除最旧视频
- **历史记录**: 按时间（30天）和数量（200-500条）双重限制
- **自动清理**: 应用启动时自动清理过期数据

### 离线模式使用

1. **查看历史记录**: 在设置页面中，即使设备未连接，也可以浏览已缓存的开锁记录和事件记录
2. **离线标识**: 离线模式下会显示"离线模式"标识，提示用户当前查看的是缓存数据
3. **数据同步**: 重新连接后，应用会自动同步最新数据并更新缓存

### 手动清理缓存

如需清理所有缓存数据：

1. 进入"设置"页面
2. 点击"清空缓存"按钮
3. 确认操作后，所有历史记录和缓存数据将被清除（应用设置和视频文件保留）

### 技术实现

- **存储引擎**: IndexedDB（浏览器原生 API）
- **数据库名称**: SmartDoorlockDB
- **服务类**: `LocalStorageService`（单例模式）
- **降级模式**: IndexedDB 不可用时自动切换到内存存储

## 配色系统与主题

应用采用完整的配色系统设计，支持浅色和深色两种主题模式。

### 主题特性

- **自动适配**: 首次启动时自动检测系统主题偏好
- **手动切换**: 用户可在设置页面手动切换主题
- **持久化**: 主题偏好自动保存到本地存储
- **无缝切换**: 主题切换时所有界面元素平滑过渡

### 配色系统

应用使用语义化的配色系统，包含以下颜色：

- **主品牌色 (Primary)**: 科技蓝 - 用于主要操作和品牌识别
- **辅助色 (Secondary)**: 智能灰 - 用于背景、文本和边框
- **成功色 (Success)**: 安全绿 - 用于设备在线、开门成功等正常状态
- **警告色 (Warning)**: 注意橙 - 用于电量低、异常访问等警告状态
- **错误色 (Error)**: 危险红 - 用于设备离线、连接失败等错误状态
- **信息色 (Info)**: 信息蓝 - 用于一般性提示和帮助信息

### 可访问性

所有颜色组合都经过严格的对比度测试，确保符合 WCAG 2.1 AA 标准：

- 正常文本对比度 ≥ 4.5:1
- 大文本对比度 ≥ 3:1
- 交互元素对比度 ≥ 3:1

详细的配色系统文档请参考：[docs/color-system.md](docs/color-system.md)

## 本地运行

**前置要求:** Node.js

1. 安装依赖:

   ```bash
   npm install
   ```

2. 设置环境变量:
   在 [.env.local](.env.local) 中设置 `GEMINI_API_KEY` 为你的 Gemini API 密钥

3. 运行应用:

   ```bash
   npm run dev
   ```

4. 运行测试:
   ```bash
   npm test
   ```

## 项目结构

```
├── App.tsx              # 根组件：全局状态管理、事件订阅
├── index.tsx            # React 入口
├── types.ts             # 共享 TypeScript 类型定义
├── components/          # 可复用 UI 组件
├── screens/             # 页面级组件
├── services/            # 业务逻辑与外部通信
│   ├── DeviceService.ts           # WebSocket 通信服务
│   ├── LocalStorageService.ts     # 本地持久化存储服务
│   ├── DeviceStatusStorageService.ts  # 设备状态存储
│   └── VideoStorageService.ts     # 视频文件存储
└── test/                # 测试文件
```

## 浏览器兼容性

- 支持所有现代浏览器（Chrome, Firefox, Safari, Edge）
- 需要支持 IndexedDB API
- 需要支持 WebSocket
- 音频功能需要 HTTPS 或 localhost 环境
