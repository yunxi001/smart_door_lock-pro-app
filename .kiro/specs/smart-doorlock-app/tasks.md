# 实现计划: 智能猫眼门锁系统 App - 功能扩展

## 概述

本计划在现有三 Tab 布局基础上，新增指纹管理、NFC 卡片管理、密码管理功能，以及历史记录视频附件功能。所有新功能基于协议规范 v2.2 实现。

## 已完成任务（上一迭代）

- [x] 底部导航架构（三 Tab 布局）
- [x] 首页功能（设备状态、开锁按钮、快捷功能、最近动态）
- [x] 实时监控功能（视频流、双向对讲）
- [x] 设置页面架构（连接配置、用户管理入口、历史记录入口）
- [x] 人脸管理功能（人员列表、录入、删除）
- [x] 到访记录功能（列表、分页）
- [x] WebSocket 通信（seq_id、server_ack、推送处理）
- [x] 数据查询功能（开锁记录、事件记录）
- [x] 到访通知弹窗

---

## 新增任务

### 阶段 1: 类型定义与服务层扩展

- [x] 1. 扩展类型定义
  - [x] 1.1 添加指纹管理类型
    - 在 `types.ts` 中添加 `Fingerprint` 接口
    - 添加 `FingerprintRegistrationStatus` 接口
    - _需求: 11.3, 11.9_
  - [x] 1.2 添加 NFC 卡片管理类型
    - 添加 `NFCCard` 接口（含脱敏卡号字段）
    - 添加 `NFCRegistrationStatus` 接口
    - _需求: 12.3, 12.9, 12.13_
  - [x] 1.3 添加密码管理类型
    - 添加 `AdminPasswordStatus` 接口
    - 添加 `TempPassword` 接口
    - 添加 `CreateTempPasswordRequest` 接口
    - _需求: 13.3, 13.8, 13.9, 13.12_
  - [x] 1.4 添加视频附件类型
    - 添加 `VideoAttachment` 接口
    - 添加 `VideoStorageStats` 接口
    - _需求: 14.1, 14.4_

- [x] 2. 扩展 DeviceService
  - [x] 2.1 添加用户管理命令方法
    - 实现 `sendUserMgmtCommand(category, command, userId, payload)` 方法
    - 支持 finger、nfc、password 三种 category
    - _需求: 11.8, 11.11, 12.8, 12.11, 13.7_
  - [x] 2.2 添加 user_mgmt_result 处理
    - 解析 `user_mgmt_result` 消息
    - 触发对应事件（finger_result、nfc_result、password_result）
    - _需求: 11.12, 12.12, 13.15_
  - [x] 2.3 添加媒体下载命令方法
    - 实现 `sendMediaDownload(fileId)` 方法
    - 实现 `sendMediaDownloadChunk(fileId, chunkIndex, chunkSize)` 方法
    - _需求: 15.1_
  - [x] 2.4 添加媒体下载响应处理
    - 解析 `media_download` 响应
    - 解析 `media_download_chunk` 响应
    - _需求: 15.2, 15.3_

- [x] 3. 检查点 - 确保服务层扩展测试通过 ✅
  - [x] 运行 DeviceService 相关测试 (28 个测试全部通过)
  - [x] 运行完整测试套件 (53 个测试全部通过)
  - [x] 确保新增方法正常工作

---

### 阶段 2: 指纹管理功能

- [x] 4. 实现指纹管理子页面
  - [x] 4.1 创建指纹管理 UI
    - 在 SettingsScreen 中实现 `fingerprint-management` 子页面
    - 显示已录入指纹列表（名称、录入时间）
    - 显示当前数量/最大容量
    - _需求: 11.1, 11.2, 11.3, 11.4_
  - [x] 4.2 实现添加指纹功能
    - 创建添加指纹弹窗组件
    - 实现指纹名称输入
    - 实现开始录入按钮
    - 显示实时录入状态
    - _需求: 11.5, 11.6, 11.7, 11.8, 11.9_
  - [x] 4.3 实现删除指纹功能
    - 添加删除按钮和确认弹窗
    - 发送删除命令
    - _需求: 11.10, 11.11_
  - [x] 4.4 实现指纹列表刷新
    - 监听 `user_mgmt_result` 事件
    - 自动刷新指纹列表
    - _需求: 11.12_

- [x] 5. 编写指纹管理测试
  - [x] 5.1 编写指纹管理命令格式测试
    - **Property 21: 指纹管理命令格式**
    - 验证 query、add、del 命令格式
  - [x] 5.2 编写 user_mgmt_result 处理测试
    - **Property 24: user_mgmt_result 处理**（finger 部分）

---

### 阶段 3: NFC 卡片管理功能

- [x] 6. 实现 NFC 卡片管理子页面
  - [x] 6.1 创建 NFC 卡片管理 UI
    - 在 SettingsScreen 中实现 `nfc-management` 子页面
    - 显示已绑定卡片列表（名称、脱敏卡号、绑定时间）
    - 显示当前数量/最大容量
    - _需求: 12.1, 12.2, 12.3, 12.4, 12.13_
  - [x] 6.2 实现添加卡片功能
    - 创建添加卡片弹窗组件
    - 实现卡片名称输入
    - 实现开始绑定按钮
    - 显示实时绑定状态
    - _需求: 12.5, 12.6, 12.7, 12.8, 12.9_
  - [x] 6.3 实现删除卡片功能
    - 添加删除按钮和确认弹窗
    - 发送删除命令
    - _需求: 12.10, 12.11_
  - [x] 6.4 实现卡片列表刷新
    - 监听 `user_mgmt_result` 事件
    - 自动刷新卡片列表
    - _需求: 12.12_

- [x] 7. 编写 NFC 卡片管理测试
  - [x] 7.1 编写 NFC 卡片管理命令格式测试
    - **Property 22: NFC 卡片管理命令格式**
    - 验证 query、add、del 命令格式
  - [x] 7.2 编写卡号脱敏测试
    - 验证卡号正确脱敏显示

- [x] 8. 检查点 - 确保指纹和 NFC 管理测试通过
  - 运行相关测试
  - 确保功能正常工作

---

### 阶段 4: 密码管理功能

- [x] 9. 实现密码管理子页面
  - [x] 9.1 创建密码管理 UI
    - 在 SettingsScreen 中实现 `password-management` 子页面
    - 显示管理员密码状态
    - 显示临时密码列表
    - _需求: 13.1, 13.2, 13.3, 13.8, 13.9_
  - [x] 9.2 实现修改管理员密码功能
    - 创建修改密码弹窗组件
    - 实现当前密码、新密码、确认密码输入
    - 发送修改命令
    - _需求: 13.4, 13.5, 13.6, 13.7_
  - [x] 9.3 实现创建临时密码功能
    - 创建临时密码弹窗组件
    - 支持选择密码类型（一次性、限时、限次）
    - 支持设置有效期和使用次数
    - 发送创建命令
    - _需求: 13.10, 13.11, 13.12, 13.13_
  - [x] 9.4 实现删除临时密码功能
    - 添加删除按钮和确认弹窗
    - _需求: 13.14_
  - [x] 9.5 实现密码列表刷新
    - 监听响应事件
    - 自动刷新密码列表
    - _需求: 13.15_

- [x] 10. 编写密码管理测试
  - [x] 10.1 编写密码管理命令格式测试
    - **Property 23: 密码管理命令格式**
    - 验证 set 命令和 temp_code 命令格式

---

### 阶段 5: 视频附件功能

- [x] 11. 创建视频存储服务
  - [x] 11.1 创建 VideoStorageService
    - 创建 `services/VideoStorageService.ts` 文件
    - 实现单例模式
    - 实现 IndexedDB 存储初始化
    - _需求: 15.6_
  - [x] 11.2 实现视频下载功能
    - 实现 `downloadVideo(attachment)` 方法
    - 实现下载进度追踪
    - 实现下载失败重试
    - _需求: 15.4, 15.5_
  - [x] 11.3 实现本地存储管理
    - 实现 `getStorageStats()` 方法
    - 实现 `clearAllVideos()` 方法
    - 实现 `cleanupOldVideos()` 方法（FIFO 策略）
    - _需求: 15.7, 15.8_

- [x] 12. 扩展历史记录 UI
  - [x] 12.1 更新开锁记录列表项
    - 添加视频附件状态显示
    - 添加视频缩略图/播放图标
    - _需求: 14.1, 14.2_
  - [x] 12.2 实现视频播放功能
    - 点击视频区域播放视频
    - 支持本地视频和在线视频
    - _需求: 14.3_
  - [x] 12.3 实现视频下载 UI
    - 显示下载状态和进度
    - 添加下载按钮
    - _需求: 14.4, 14.5, 14.6, 14.7_
  - [x] 12.4 实现存储管理 UI
    - 在设置页面添加存储管理入口
    - 显示已用空间
    - 提供清理选项
    - _需求: 14.10_

- [x] 13. 实现自动下载功能
  - [x] 13.1 检测非监控模式
    - 监听监控状态变化
    - 在非监控模式下启动后台下载
    - _需求: 14.9_
  - [x] 13.2 实现下载队列管理
    - 维护待下载视频队列
    - 按优先级下载
    - _需求: 14.8_

- [x] 14. 编写视频附件测试
  - [x] 14.1 编写媒体下载命令格式测试
    - **Property 25: 媒体下载命令格式**
  - [x] 14.2 编写媒体下载响应处理测试
    - **Property 26: 媒体下载响应处理**

- [x] 15. 检查点 - 确保密码管理和视频附件测试通过
  - 运行相关测试
  - 确保功能正常工作

---

### 阶段 6: 集成与优化

- [x] 16. 更新 App.tsx 状态管理
  - [x] 16.1 添加新功能状态
    - 添加 fingerprints 状态
    - 添加 nfcCards 状态
    - 添加 tempPasswords 状态
    - 添加 videoAttachments 状态
  - [x] 16.2 添加新事件订阅
    - 订阅 finger_result 事件
    - 订阅 nfc_result 事件
    - 订阅 password_result 事件
    - 订阅 media_download 事件

- [x] 17. 更新 SettingsScreen Props
  - [x] 17.1 传递新功能数据
    - 传递 fingerprints 到子页面
    - 传递 nfcCards 到子页面
    - 传递 tempPasswords 到子页面
  - [x] 17.2 传递回调函数
    - 传递指纹管理回调
    - 传递 NFC 卡片管理回调
    - 传递密码管理回调

- [x] 18. 最终检查点 - 确保所有测试通过
  - 运行完整测试套件
  - 确保所有属性测试通过
  - 如有问题请询问用户

- [x] 19. 代码审查和优化
  - [x] 19.1 检查代码质量
    - 检查未使用的导入和变量
    - 确保中文注释和日志
    - 检查 TypeScript 类型完整性
  - [x] 19.2 性能优化
    - 检查大列表渲染性能
    - 优化视频下载内存使用

---

## 任务依赖关系

```
阶段 1 (类型定义与服务层)
    ↓
阶段 2 (指纹管理) ─┬─ 阶段 3 (NFC 卡片管理)
                   ↓
              阶段 4 (密码管理)
                   ↓
              阶段 5 (视频附件)
                   ↓
              阶段 6 (集成与优化)
```

## 备注

- 阶段 2、3 可并行开发，因为它们使用相同的 `user_mgmt` 协议结构
- 视频附件功能（阶段 5）相对独立，可根据优先级调整开发顺序
- 每个检查点任务用于阶段性验证，确保增量开发的稳定性
- 属性测试使用 fast-check 库，每个测试至少运行 100 次迭代
